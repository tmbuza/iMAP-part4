# (PART) ALPHA DIVERSITY {-}
# Alpha Diversity Analysis {#alpha-diversity}

```{r include=FALSE}
library(vegan)
library(tidyverse)
library(phyloseq)
path_shared <- "~/Dropbox/CDILLC/GIT_REPOS/smda-end2end/data/final.tx.shared"
```

## Basic diversity metrics {#count_n_metrics}
```{r}
set.seed(2022)
shared <- read_tsv("~/Dropbox/CDILLC/GIT_REPOS/smda-end2end/data/final.tx.shared", 
                   show_col_types = F) %>%
select(sample_id = Group, starts_with("Phylo")) %>% 
  pivot_longer(-sample_id, names_to = "otu", values_to = "count") %>%
  group_by(sample_id) %>%
  mutate(total = sum(count)) %>%
  filter(total > 0) %>%
  group_by(otu) %>%
  mutate(total = sum(count)) %>%
  filter(total != 0) %>%
  ungroup() %>%
  select(-total)

count <- shared %>% 
  group_by(sample_id) %>% 
  summarise(count = sum(count), .groups = "drop")

## Random sampling
rand <- shared %>%
  uncount(count) %>%
  mutate(otu = sample(otu)) %>%
  count(sample_id, otu, name = "count")

## Diversity metrics
source("R/alpha.R")
set.seed(2022)

div_metrics <- shared %>%
  group_by(sample_id) %>%
  summarise(sobs = richness(count),
            shannon = shannon(count),
            simpson = simpson(count),
            invsimpson = 1/simpson) %>% 
  inner_join(count, ., by = "sample_id")

div_metrics %>% 
  saveRDS("RDataRDS/div_metrics.rds")

div_metrics %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F, bootstrap_options = "basic")
```


## Diversity plots

### Using original count
```{r message=FALSE, warning=FALSE}
readRDS("RDataRDS/div_metrics.rds") %>%
  pivot_longer(cols=c(sobs, shannon, invsimpson, simpson),
               names_to="metric") %>%
  ggplot(aes(x=count, y=value)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~metric, nrow=4, scales="free_y") + 
  theme_bw() +
  theme(panel.grid = element_blank())
```

### Using randomly sampled count
```{r}
source("R/alpha.R")
library(vegan)
set.seed(2022)

rand %>%
  group_by(sample_id) %>%
  summarise(sobs = richness(count),
            shannon = shannon(count),
            simpson = simpson(count),
            invsimpson = 1/simpson,
            n = sum(count)) %>%
  pivot_longer(cols=c(sobs, shannon, invsimpson, simpson),
               names_to="metric") %>%
  ggplot(aes(x=n, y=value)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~metric, nrow=4, scales="free_y") + 
  theme_bw() +
  theme(panel.grid = element_blank())
```


## Sampling coverage 
```{r}
sampling_coverage <- shared %>% 
  group_by(sample_id) %>% 
summarise(n_seq = sum(count)) %>% 
arrange(n_seq)
```

### Histogram
```{r}
sampling_coverage %>%
  ggplot(aes(x = n_seq)) +
  geom_histogram()
```


### Line plot
```{r}
set.seed(2022)
sampling_coverage %>%
  arrange(n_seq) %>%
  ggplot(aes(x = 1:nrow(.), y= n_seq)) +
  geom_line() +
  scale_x_continuous(n.breaks = nrow(sampling_coverage)) +
  labs(x = "Data Point", y = " Number Sequences") +
  theme_bw()
```

### Point plot
```{r}
set.seed(2022)
sampling_coverage %>%
  arrange(n_seq) %>%
  ggplot(aes(x = 1:nrow(.), y= n_seq)) +
  geom_jitter() +
  scale_x_continuous(n.breaks = nrow(sampling_coverage)) +
  labs(x = "Data Point", y = " Number Sequences") +
  theme_bw()
```

### Singletons and coverage statistics
```{r}
set.seed(2022)
coverage_stats <- shared %>%
  group_by(sample_id) %>%
  summarise(n_seqs = sum(count),
            n_sings =sum(count == 1),
            coverage = 100*(1 - n_sings/n_seqs)) %>%
  filter(n_seqs > 0) %>%
  as.data.frame() %>%
  write_tsv("RDataRDS/sample_coverage.tsv")

as.data.frame(read_tsv("RDataRDS/sample_coverage.tsv", show_col_types = F)) %>% 
  kableExtra::kable(format = "html") %>% 
  kableExtra::kable_styling(full_width = F, bootstrap_options = "basic")
```


# Diversity Using Phyloseq Objects

## Load library and data
```{r}
library(phyloseq)
library(tidyverse, suppressPackageStartupMessages())

load("../iMAP-part3/RDataRDS/phyloseq_objects.RData", verbose = F)
```

### Raw abundnace
```{r}
(ps_raw <- ps_raw)
otu_table(ps_raw)[1:5, 1:3]
```

### Relative abundnace
```{r}
(ps_rel <- ps_rel)
otu_table(ps_rel)[1:5, 1:3]
```

## Diversity metrics
> Diversity metric functions accept only **integers (counts)** 
> .
> Note: Multiple metrics are computed automatically when using phyloseq `estimate_richness` function.

```{r fig.dim=c(8, 10)}
set.seed(1234)

ps <- ps_raw

alpha_div_tbl <- data.frame(
  "sample_id" = sample_names(ps),
  "group" = phyloseq::sample_data(ps)$isolate,
  "n_read" = phyloseq::sample_sums(ps),
  phyloseq::estimate_richness(ps),
  "phylodiv" = picante::pd(samp = data.frame(t(data.frame(phyloseq::otu_table(ps)))), 
                           tree = phyloseq::phy_tree(ps))[, 1])

saveRDS(alpha_div_tbl, file = "RDataRDS/ps_alpha_div_tbl.rds")

readRDS("RDataRDS/ps_alpha_div_tbl.rds") %>%
  rename(sobs = Observed, 
         chao = Chao1, 
         ace = ACE,
         simpson = Simpson, 
         invsimpson = InvSimpson, 
         shannon = Shannon,
         fisher = Fisher) %>% 
  pivot_longer(cols=c(sobs, 
                      chao, 
                      ace,
                      simpson, 
                      invsimpson, 
                      shannon,
                      fisher,
                      phylodiv),
               names_to="metric", 
               values_to = "value") %>% 
  ggplot(aes(x = n_read, y=value)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~metric, nrow=8, scales="free_y") + 
  theme_bw() +
  theme(panel.grid = element_blank())
```


## Median Sequencing Depth.
Total Observed Richness
```{r}
total = median(sample_sums(ps))
standf = function(x, t=total) round(t * (x / sum(x)))
ps = transform_sample_counts(ps, standf)

ggplot(data = data.frame("TotalReads" =  phyloseq::sample_sums(ps),
                         "observed" = phyloseq::estimate_richness(ps, measures = "Observed")[, 1]),
       aes(x = TotalReads, y = observed)) +
  geom_point() +
  geom_smooth(method="lm", se = FALSE) +
  labs(x = "\nTotal Reads", y = "Observed Richness\n")

```

## Rarefaction at even depth
- Subsample reads from each sample without replacement.
- Then estimate alpha-diversity.

```{r fig.height=5, fig.width=10, message=FALSE, warning=FALSE, include=F}
set.seed(2022) # for repeatable random sub sampling

subsample <- phyloseq::rarefy_even_depth(ps, sample.size = 1500,
  rngseed = FALSE, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)
```

## Manually selected iversity metrics
```{r fig.dim=c(8, 10)}
set.seed(1234)

alpha_div_tbl <- data.frame(
  "Sample_ID" = sample_names(subsample),
  "Variable" = phyloseq::sample_data(subsample)$isolate,
  "TotalReads" = phyloseq::sample_sums(subsample),
  "Observed" = phyloseq::estimate_richness(subsample, measures = "Observed"),
  "ACE" = phyloseq::estimate_richness(subsample, measures = "ACE"),
  "Estimated" = phyloseq::estimate_richness(subsample, measures = "Chao1"),
  "Simpson" = phyloseq::estimate_richness(subsample, measures = "Simpson"),
  "InvSimpson" = phyloseq::estimate_richness(subsample, measures = "InvSimpson"),
  "Shannon" = phyloseq::estimate_richness(subsample, measures = "Shannon"),
  "Fisher" = phyloseq::estimate_richness(subsample, measures = "Fisher"),
  "PhyloDiv" = picante::pd(samp = data.frame(t(data.frame(phyloseq::otu_table(subsample)))), 
                           tree = phyloseq::phy_tree(subsample))[, 1])
 count_tbl <- alpha_div_tbl %>%
  rename_all(tolower) %>% 
  rename(sobs = observed, 
         n_reads = totalreads, 
         chao1 = estimated.chao1, 
         ace = ace.ace) 
 
 count_tbl %>% 
  pivot_longer(cols=c(sobs, 
                      chao1, 
                      ace,
                      simpson, 
                      invsimpson, 
                      shannon,
                      fisher,
                      phylodiv),
               names_to="metric", 
               values_to = "value") %>%  
   select(-ace.se.ace, -estimated.se.chao1) %>%  
   saveRDS("RDataRDS/ps_alpha_div_tbl.rds")
 
 readRDS("RDataRDS/ps_alpha_div_tbl.rds")
```

## Visualize alpha diversity
```{r fig.dim=c(8, 8)}
set.seed(1234)

readRDS("RDataRDS/ps_alpha_div_tbl.rds") %>%
  ggplot(aes(x = n_reads, y=value, color = variable)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~metric, ncol=2, scales="free_y") + 
  theme_bw() +
  theme(panel.grid = element_blank())

```

## Alpha  Hypothesis Testing
- Assess the variation in alpha-diversity between groups.
- Then accept or reject the null hypothesis that there is no difference in location between groups.
- Box plots can show the location of the median.
- Perform samples Wilcoxon test.

## Summarize
```{r}
set.seed(1234)

readRDS("RDataRDS/ps_alpha_div_tbl.rds") %>%
  pivot_wider(id_cols = sample_id, names_from = metric, values_from = value) %>% 
  group_by(sample_id) %>%
    dplyr::summarise(
      median_observed = median(sobs),
      median_invsimpson = median(invsimpson),
      median_shannon = median(shannon)
      )
```

## Paired Wilcoxon test

### Observed vs Group variable
```{r}
bufwilde <- count_tbl %>% 
  filter(variable == "Buffalo"|
         variable == "Wildebeest") %>% 
select(-sample_id, -variable)

wilcox.test(bufwilde$sobs, exact = TRUE, conf.int = TRUE)

```

### Shannon vs Group
```{r}
wilcox.test(bufwilde$shannon, exact = FALSE, conf.int = TRUE)
```

### InvSimpson vs Group
```{r}
wilcox.test(bufwilde$invsimpson, exact = FALSE, conf.int = TRUE)
```

### Phylo Diversity vs Group
```{r}
wilcox.test(bufwilde$phylodiv, exact = FALSE, conf.int = TRUE)
```

## Breakaway estimates richness
- Estimate richness using breakaway
- Betta function tests for heterogeneity of total diversity (observed plus unobserved) across multiple sites. 
- It can account or test for fixed effects that may explain diversity. 
- It returns the significance of the covariates in explaining diversity and a hypothesis test for heterogeneity.
```{r}
library(breakaway)
ba_adiv <- breakaway::breakaway(ps)
ba_adiv[1]

#Plot estimates
plot(ba_adiv, ps, color = "isolate")     

#Examine models
summary(ba_adiv) %>%
  add_column("Group" = ps %>% otu_table %>% sample_names)  

# Test for group differ
bt <- breakaway::betta(summary(ba_adiv)$estimate, summary(ba_adiv)$error, make_design_matrix(ps, "isolate"))
bt$table
```

